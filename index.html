<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>新年烟花送祝福</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            overflow: hidden;
            background: #000;
            touch-action: none;
        }
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            background: #000; /* 强制初始黑色背景，避免黑屏 */
        }
        .start-tip {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 28px;
            font-weight: bold;
            text-shadow: 0 0 10px #ff0, 0 0 20px #ff0, 0 0 30px #ff0;
            cursor: pointer;
            z-index: 20;
            transition: all 0.5s ease;
        }
        .start-tip.hide {
            opacity: 0;
            pointer-events: none;
            transform: translate(-50%, -50%) scale(0.8);
        }
        .running-tip {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            font-size: 16px;
            text-shadow: 0 0 5px #ff0;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .running-tip.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="start-tip" id="startTip">点击这里签收</div>
    <div class="running-tip" id="runningTip">点击可以放烟花呦~</div>
    <canvas id="fireworksCanvas"></canvas>

    <!-- 闭合audio标签，避免HTML解析错误 -->
    <audio id="riseSound" preload="none" style="display: none;" volume="0.05">
        <source src="rise.mp3" type="audio/mpeg">
    </audio>
    <audio id="boomSound1" preload="none" style="display: none;" volume="1.0">
        <source src="boom1.mp3" type="audio/mpeg">
    </audio>
    <audio id="boomSound2" preload="none" style="display: none;" volume="1.0">
        <source src="boom2.mp3" type="audio/mpeg">
    </audio>

    <script>
        // 确保DOM加载完成后执行脚本
        document.addEventListener('DOMContentLoaded', function() {
            // 核心元素与状态
            const canvas = document.getElementById('fireworksCanvas');
            const ctx = canvas.getContext('2d');
            const startTip = document.getElementById('startTip');
            const runningTip = document.getElementById('runningTip');
            const riseSound = document.getElementById('riseSound');
            const boomSound1 = document.getElementById('boomSound1');
            const boomSound2 = document.getElementById('boomSound2');
            
            // 防错：确保画布上下文获取成功
            if (!ctx) {
                alert('您的浏览器不支持Canvas，无法显示烟花效果');
                return;
            }

            let isStarted = false;
            let isFirstFireworkDone = false;
            let isFirstFirework = true; // 新增：标记是否是首次烟花
            let autoTimer = null;
            let riseTrailPoints = [];
            let riseInterval = null; // 新增：保存上升定时器，用于彻底清除
            let firstFireworkX = canvas.width / 2;
            let explodeHeight = canvas.height / 2;
            // 祝福语数组
            const wishList = [
                "新年快乐", "万事顺意", "朝朝暮暮", "一生被爱", "平安喜乐",
                "前程似锦", "笑口常开", "心想事成", "喜乐无忧", "与你同喜",
                "小薄同学", "小薄同学", "小薄同学", "小薄同学", "小薄同学"
            ];
            let wishTexts = []; // 存储文字对象

            // 【新增】开场文字配置
            const openingTexts = [
                { text: "很高兴在今年遇见你", sizeRatio: 0.05, duration: 2500 },
                { text: "时间的故事一定会更精彩", sizeRatio: 0.05, duration: 2500 },
                { text: "此刻我想对你说四个字", sizeRatio: 0.05, duration: 2500 },
                { 
                    text: "新年快乐！", 
                    sizeRatio: 0.08, 
                    duration: 3000,
                    subText: "还有烟花哟~", // 新增副标题
                    subSizeRatio: 0.03 // 副标题字号比例
                }
            ];
            let currentOpeningTextIndex = 0; // 当前显示的开场文字索引
            let isShowingOpeningText = false; // 是否正在显示开场文字
            let openingTextObj = null; // 当前开场文字对象

            // 【新增】星空和新烟花效果相关变量
            let stars = [];
            let rings = [];
            let newParticles = []; // 新烟花粒子数组

            // 配置参数（【关键修改】增强烟花厚重感）
            const RISE_DURATION = 3000; // 缩短上升时间，提升流畅度
            const HEART_SCALE = 3.5;
            const TRAIL_DECAY = 0.15; 
            const TEXT_DECAY = 0.01; 
            let particles = [];

            // 画布适配
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                firstFireworkX = canvas.width / 2;
                explodeHeight = canvas.height / 2;
                // 重绘黑色背景
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                // 【新增】初始化星空
                initStars();
            }

            // 【新增】初始化星空
            function initStars() {
                stars = [];
                for (let i = 0; i < 100; i++) {
                    stars.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        size: Math.random() * 1.2,
                        opacity: Math.random(),
                        speed: 0.005 + Math.random() * 0.015
                    });
                }
            }

            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // 工具函数
            function random(min, max) { return Math.random() * (max - min) + min; }
            // 生成同色系颜色（心形烟花）
            function getHeartColorSet() {
                const baseHue = random(0, 360);
                return {
                    main: `hsl(${baseHue}, 100%, 60%)`,
                    light: `hsl(${baseHue}, 100%, 75%)`,
                    dark: `hsl(${baseHue}, 100%, 45%)`
                };
            }
            // 随机获取祝福语
            function getRandomWish() {
                return wishList[Math.floor(random(0, wishList.length))];
            }
            // 适配文字大小
            function getAdaptedTextSize() {
                const minSize = Math.min(canvas.width, canvas.height) * 0.02;
                const maxSize = Math.min(canvas.width, canvas.height) * 0.035;
                return random(minSize, maxSize);
            }
            // 随机颜色（普通烟花）
            function randomColor() {
                const colors = ['#ff0000', '#ff9900', '#ffff00', '#00ff00', '#0099ff', '#0033ff', '#9900ff', '#ff0099'];
                return colors[Math.floor(random(0, colors.length))];
            }

            // ===================== 关键修改1：全局音频解锁 =====================
            let isAudioUnlocked = false; // 标记音频是否已解锁
            // 全局音频解锁函数（任意用户交互都能触发）
            function unlockAudioGlobally() {
                if (isAudioUnlocked) return; // 已解锁则直接返回
                // 播放并立即暂停，解锁音频上下文
                [riseSound, boomSound1, boomSound2].forEach(sound => {
                    if (sound) {
                        sound.muted = true; // 静音播放，避免突兀
                        sound.play().then(() => {
                            sound.pause();
                            sound.muted = false;
                            sound.currentTime = 0;
                            isAudioUnlocked = true; // 标记为已解锁
                        }).catch(err => console.log("音频解锁失败:", err));
                    }
                });
                // 解锁后移除全局事件监听，避免重复执行
                document.removeEventListener('click', unlockAudioGlobally);
                document.removeEventListener('touchstart', unlockAudioGlobally);
            }
            // 页面加载后立即绑定全局交互事件，提前解锁音频
            document.addEventListener('click', unlockAudioGlobally, { once: true });
            document.addEventListener('touchstart', unlockAudioGlobally, { once: true, passive: true });

            // 音频逻辑（优化：优先判断是否已解锁）
            function forcePlayAudio(audio) {
                if (!audio || !isAudioUnlocked) return;
                try {
                    audio.currentTime = 0;
                    audio.play().catch(err => {
                        console.log("音频播放失败:", err);
                        // 降级方案：再次尝试（用户交互后）
                        setTimeout(() => audio.play(), 100);
                    });
                } catch (e) {
                    console.log("音频播放异常:", e);
                }
            }

            // 替换原 playRiseSound 函数（提升上升音效音量）
            function playRiseSound() { 
                if (!riseSound || !isAudioUnlocked) return;
                riseSound.volume = 0.5; // 从 0.05 提升到 0.5，能清晰听到
                forcePlayAudio(riseSound); 
                setTimeout(() => { 
                    riseSound.pause(); 
                    riseSound.currentTime = 0; // 重置播放位置
                }, RISE_DURATION); 
            }

            // 替换原 playBoomSound 函数
            function playBoomSound() { 
                if (!isAudioUnlocked) return;
                const boomSound = Math.random() > 0.8 ? boomSound1 : boomSound2;
                if (boomSound) {
                    boomSound.volume = 1.0;
                    forcePlayAudio(boomSound);
                }
            }
            // 【新增】增强版播放音频函数
            function playSound(audio, volume = 0.5) {
                if (!audio || !isAudioUnlocked) return;
                audio.currentTime = 0;
                audio.volume = volume;
                audio.play().catch(e => {
                    console.log("播放失败:", e);
                    // 解锁后重试
                    setTimeout(() => audio.play(), 100);
                });
            }

            // 【核心修改1：新粒子类增强】放大粒子尺寸，增加轨迹长度
            class NewParticle {
                constructor(x, y, color, speed, angle, friction = 0.95, gravity = 0.08) {
                    this.x = x; this.y = y; this.color = color;
                    this.alpha = 1;
                    this.decay = random(0.025, 0.04);
                    this.vx = Math.cos(angle) * speed;
                    this.vy = Math.sin(angle) * speed;
                    this.friction = friction;
                    this.gravity = gravity;
                    this.history = [];
                }
                update() {
                    this.history.push({x: this.x, y: this.y});
                    if (this.history.length > 8) this.history.shift(); // 轨迹长度从5增加到8
                    this.vx *= this.friction;
                    this.vy *= this.friction;
                    this.vy += this.gravity;
                    this.x += this.vx;
                    this.y += this.vy;
                    this.alpha -= this.decay;
                }
                draw() {
                    if (this.alpha <= 0) return;
                    ctx.save();
                    if(this.history.length > 1) {
                        ctx.beginPath();
                        ctx.moveTo(this.history[0].x, this.history[0].y);
                        for(let p of this.history) ctx.lineTo(p.x, p.y);
                        ctx.strokeStyle = this.color;
                        ctx.globalAlpha = this.alpha * 0.5; // 轨迹透明度从0.3提升到0.5，更明显
                        ctx.lineWidth = 1.2; // 轨迹线宽从默认1增加到1.5
                        ctx.stroke();
                    }
                    ctx.globalAlpha = this.alpha;
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, 2.5, 0, Math.PI * 2); // 粒子尺寸从1.3放大到2.5
                    ctx.fill();
                    ctx.restore();
                }
            }

            // 【核心修改2：圆环类增强】加宽圆环线宽
            class Ring {
                constructor(x, y, color) {
                    this.x = x; this.y = y; this.color = color;
                    this.radius = 0; this.alpha = 0.6; // 透明度从0.4提升到0.6，更醒目
                }
                update() { this.radius += 3; this.alpha -= 0.04; }
                draw() {
                    if (this.alpha <= 0) return;
                    ctx.save();
                    ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.strokeStyle = this.color; ctx.globalAlpha = this.alpha;
                    ctx.lineWidth = 3; // 圆环线宽从2增加到3
                    ctx.stroke();
                    ctx.restore();
                }
            }

            // 【新增】绘制星空
            function drawStars() {
                stars.forEach(s => {
                    s.opacity += s.speed;
                    if (s.opacity > 1 || s.opacity < 0) s.speed = -s.speed;
                    ctx.fillStyle = `rgba(255, 255, 255, ${s.opacity})`;
                    ctx.fillRect(s.x, s.y, s.size, s.size);
                });
            }

            // 【新增】更新新烟花粒子和圆环
            function updateNewFireworkElements() {
                // 更新圆环
                rings.forEach((r, i) => { 
                    r.update(); 
                    r.draw(); 
                    if (r.alpha <= 0) rings.splice(i, 1); 
                });
                // 更新新粒子
                newParticles.forEach((p, i) => { 
                    p.update(); 
                    p.draw(); 
                    if (p.alpha <= 0) newParticles.splice(i, 1); 
                });
            }

            // 【核心修改3：增加粒子数量】普通烟花粒子从90个增加到150个，心形烟花从180个增加到400个
            function createNewFirework(x, y, isHeart = false, customWish = null) {
                const hue = Math.random() * 360;
                const color = `hsl(${hue}, 100%, 65%)`;
                // 优先使用自定义文字，否则随机获取
                const wish = customWish || getRandomWish();
                
                // 添加圆环（新增：每个烟花添加2个圆环，增强层次感）
                rings.push(new Ring(x, y, color));
                rings.push(new Ring(x, y, `hsl(${hue}, 100%, 80%)`)); // 浅色外环
                // 播放音效（优化：使用全局解锁后的播放逻辑）
                playSound(Math.random() > 0.5 ? boomSound1 : boomSound2, 0.8);

                // 心形烟花（小薄同学）
                if (isHeart || wish === "小薄同学") {
                    for (let i = 0; i < 120; i++) {
                        const angle = Math.random() * Math.PI * 2;
                        const r = 15;
                        const vx = r * Math.pow(Math.sin(angle), 3);
                        const vy = -(13 * Math.cos(angle) - 5 * Math.cos(2 * angle) - 2 * Math.cos(3 * angle) - Math.cos(4 * angle));
                        const p = new NewParticle(x, y, `hsl(${hue}, 100%, 75%)`, 0, 0, 0.96, 0.04);
                        p.vx = vx * 0.28; p.vy = vy * 0.28;
                        newParticles.push(p);
                    }
                } else {
                    // 普通烟花
                    for (let i = 0; i < 100; i++) {
                        newParticles.push(new NewParticle(x, y, color, random(2, 7), Math.random() * Math.PI * 2));
                    }
                }
                // 添加祝福语（保留原文字逻辑）
                createWishText(x, y, `hsl(${hue}, 100%, 85%)`, wish);
            }

            // 【核心修改4：原粒子类增强】放大粒子尺寸
            class Particle {
                constructor(x, y, color, size = 3, decay = random(0.03, 0.04), isHighlight = false) {
                    this.x = x; 
                    this.y = y; 
                    this.color = color; 
                    this.size = size; // 粒子尺寸从2增加到3
                    this.alpha = 1; 
                    this.decay = decay;
                    this.vx = 0; 
                    this.vy = 0;
                    this.isHighlight = isHighlight;
                    this.flashSpeed = isHighlight ? random(0.02, 0.04) : 0;
                }
                update() {
                    this.x += this.vx;
                    this.y += this.vy;
                    if (this.isHighlight) {
                        this.alpha = Math.max(0, this.alpha - this.decay + Math.sin(Date.now() * 0.005) * this.flashSpeed);
                    } else {
                        this.alpha = Math.max(0, this.alpha - this.decay);
                    }
                    this.vy += 0.03;
                }
                draw() {
                    if (this.alpha <= 0) return;
                    ctx.save(); 
                    ctx.globalAlpha = this.alpha; 
                    ctx.fillStyle = this.color;
                    if (this.isHighlight) {
                        ctx.shadowBlur = 4; // 阴影模糊度从2增加到4，更厚重
                        ctx.shadowColor = this.color;
                    }
                    ctx.beginPath(); 
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); 
                    ctx.fill(); 
                    ctx.restore();
                }
            }

            // 重构：接收指定的祝福语文本，不再随机生成
            function createWishText(x, y, color, text) {
                wishTexts.push({
                    x: x,
                    y: y,
                    text: text, // 使用传入的指定文本
                    alpha: 1,
                    color: color,
                    size: getAdaptedTextSize()
                });
            }
            function drawWishText(textObj) {
                if (textObj.alpha <= 0) return;
                ctx.save();
                ctx.globalAlpha = textObj.alpha;
                ctx.font = `bold ${textObj.size}px PingFang SC, Microsoft YaHei, sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = textObj.color;
                ctx.shadowBlur = 6;
                ctx.shadowColor = textObj.color;
                ctx.fillText(textObj.text, textObj.x, textObj.y);
                ctx.restore();
            }
            function updateWishTexts() {
                wishTexts.forEach((text, i) => {
                    text.alpha = Math.max(0, text.alpha - TEXT_DECAY);
                    drawWishText(text);
                    if (text.alpha <= 0) wishTexts.splice(i, 1);
                });
            }

            // 【新增】绘制开场文字
            function drawOpeningText() {
                if (!openingTextObj) return;
                
                ctx.save();
                ctx.globalAlpha = openingTextObj.alpha;
                // 设置字体样式，最后一句更大
                const fontSize = Math.min(canvas.width, canvas.height) * openingTextObj.sizeRatio;
                ctx.font = `bold ${fontSize}px PingFang SC, Microsoft YaHei, sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = '#fff';
                ctx.shadowBlur = 10;
                ctx.shadowColor = '#ffcc00';
                // 绘制主文字
                ctx.fillText(openingTextObj.text, canvas.width / 2, canvas.height / 2);

                // 绘制副标题（还有烟花哟~~）
                if (openingTextObj.subText) {
                    const subFontSize = Math.min(canvas.width, canvas.height) * openingTextObj.subSizeRatio;
                    ctx.font = `bold ${subFontSize}px PingFang SC, Microsoft YaHei, sans-serif`;
                    // 副标题位置：主文字下方，间距为字号的1.2倍
                    const offsetY = (fontSize + subFontSize) * 1.2 / 2;
                    ctx.fillText(openingTextObj.subText, canvas.width / 2, canvas.height / 2 + offsetY);
                }

                ctx.restore();

                // 更新文字透明度（浮现/消失动画）
                if (openingTextObj.isFadingIn) {
                    openingTextObj.alpha += 0.01;
                    if (openingTextObj.alpha >= 1) {
                        openingTextObj.isFadingIn = false;
                        // 停留指定时长后开始消失
                        setTimeout(() => {
                            openingTextObj.isFadingOut = true;
                        }, openingTextObj.duration);
                    }
                } else if (openingTextObj.isFadingOut) {
                    openingTextObj.alpha -= 0.01;
                    if (openingTextObj.alpha <= 0) {
                        // 当前文字消失，切换到下一个
                        openingTextObj = null;
                        currentOpeningTextIndex++;
                        if (currentOpeningTextIndex < openingTexts.length) {
                            showNextOpeningText();
                        } else {
                            // 所有开场文字显示完毕
                            isShowingOpeningText = false;
                            // 开启自动烟花和提示
                            startAutoFirework();
                            runningTip.classList.add('show');
                        }
                    }
                }
            }

            // 【新增】显示下一个开场文字
            function showNextOpeningText() {
                if (currentOpeningTextIndex >= openingTexts.length) return;
                
                const textConfig = openingTexts[currentOpeningTextIndex];
                openingTextObj = {
                    text: textConfig.text,
                    sizeRatio: textConfig.sizeRatio,
                    duration: textConfig.duration,
                    subText: textConfig.subText || '', // 副标题
                    subSizeRatio: textConfig.subSizeRatio || 0, // 副标题字号比例
                    alpha: 0,
                    isFadingIn: true,
                    isFadingOut: false
                };
            }

            // 【新增】启动开场文字动画
            function startOpeningTextAnimation() {
                isShowingOpeningText = true;
                currentOpeningTextIndex = 0;
                showNextOpeningText();
            }

            // 上升轨迹 - 优化：彻底清除无残留
            function updateRiseTrail(y) {
                riseTrailPoints.push(new Particle(firstFireworkX, y, randomColor(), 1, TRAIL_DECAY));
                riseTrailPoints.forEach(p => p.update());
                riseTrailPoints = riseTrailPoints.filter(p => p.alpha > 0);
                riseTrailPoints.forEach(p => p.draw());
            }
            // 重写：彻底清空轨迹粒子，替代原衰减方式，解决尾迹残留
            function clearRiseTrail() {
                riseTrailPoints = []; // 直接清空数组，无任何残留
                if (riseInterval) {
                    clearInterval(riseInterval); // 清除定时器，停止生成新轨迹
                    riseInterval = null;
                }
            }

            // 【改造】统一的烟花生成逻辑（使用新烟花效果）
            function createFireworkByWish(x, y) {
                // 先随机获取祝福语
                const wishText = getRandomWish();
                // 判断是否是“小薄同学”，是则生成心形，否则生成普通
                createNewFirework(x, y, wishText === "小薄同学");
            }

            // 【改造】自动燃放烟花：使用新烟花效果
            function createAutoFireworkBatch() {
                if (!isFirstFireworkDone || isShowingOpeningText) return; // 开场文字显示时不生成自动烟花
                const count = Math.floor(random(3, 5));
                for (let i = 0; i < count; i++) {
                    setTimeout(() => {
                        const x = random(canvas.width * 0.1, canvas.width * 0.9);
                        const y = random(canvas.height * 0.2, canvas.height * 0.7);
                        // 调用新烟花生成逻辑
                        createNewFirework(x, y);
                    }, random(50, 200) * i);
                }
            }
            function startAutoFirework() {
                createAutoFireworkBatch();
                autoTimer = setInterval(createAutoFireworkBatch, random(2000, 3500));
            }

            // 【改造】首个爱心烟花 - 强制使用列表最后一个文字
            // 升级版：首个爱心烟花（多发连弹）
            function startFirstHeartFirework() {
                const positions = [
                    { x: canvas.width * 0.3, delay: 0, text: "新年快乐" },
                    { x: canvas.width * 0.7, delay: 400, text: "万事顺意" },
                    { x: canvas.width * 0.5, delay: 1000, text: "小薄同学" } // 最后一个是大招
                ];

                positions.forEach(pos => {
                    setTimeout(() => {
                        let currentY = canvas.height;
                        const targetX = pos.x;
                        const targetY = canvas.height * random(0.3, 0.5);
                        const riseDuration = 2000; 
                        const riseSpeed = (canvas.height - targetY) / riseDuration;

                        playRiseSound();

                        let localRiseInterval = setInterval(() => {
                            currentY -= riseSpeed * 16;
                            // 绘制轨迹（注意：这里需要微调轨迹函数支持指定X坐标）
                            riseTrailPoints.push(new Particle(targetX, currentY, '#ffcc00', 1, TRAIL_DECAY));
                            
                            if (currentY <= targetY) {
                                clearInterval(localRiseInterval);
                                // 彻底清除该路径点（为了不留尾迹）
                                riseTrailPoints = riseTrailPoints.filter(p => Math.abs(p.x - targetX) > 5); 
                                
                                // 最后一个展示心形，前面的展示普通
                                const isLast = pos.text === "小薄同学";
                                createNewFirework(targetX, targetY, isLast, pos.text);

                                if(isLast) {
                                    setTimeout(() => {
                                        isFirstFireworkDone = true;
                                        // 首个烟花完成后，启动开场文字动画
                                        startOpeningTextAnimation();
                                    }, 1000);
                                }
                            }
                        }, 16);
                    }, pos.delay);
                });
            }

            // 改造点击放烟花：使用新烟花效果
            function clickToFirework(x, y) {
                if (!isStarted || !isFirstFireworkDone || isShowingOpeningText) return; // 开场文字显示时不允许点击放烟花
                createNewFirework(x, y);
            }

            // 动画主循环 - 整合星空和新烟花效果
            function animate() {
                // 半透明覆盖，实现残影（透明度从 0.12 提升到 0.2，更快覆盖）
                ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // 【新增】绘制星空
                drawStars();

                // 仅当轨迹数组有内容时才绘制，避免空绘制残留
                if (riseTrailPoints.length > 0) {
                    riseTrailPoints.forEach(p => p.draw());
                }
                // 绘制原粒子（兼容）
                particles.forEach((p, i) => { 
                    p.update(); 
                    p.draw(); 
                    if (p.alpha <= 0) particles.splice(i, 1); 
                });
                // 【新增】更新新烟花元素（粒子+圆环）
                updateNewFireworkElements();

                // 绘制祝福语
                updateWishTexts();

                // 【新增】绘制开场文字
                if (isShowingOpeningText) {
                    drawOpeningText();
                }

                // 循环动画
                requestAnimationFrame(animate);
            }
            // 启动动画循环
            animate();

            // 开始所有效果
            function startAll() {
                if (isStarted) return;
                isStarted = true;
                startTip.classList.add('hide');
                unlockAudioGlobally(); // 兜底：再次触发解锁（防止全局解锁未执行）
                setTimeout(startFirstHeartFirework, 300);
            }

            // ===================== 核心修改：仅保留文字区域的启动逻辑 =====================
            // 仅绑定文字的点击事件来启动
            startTip.addEventListener('click', startAll);
            
            // 画布点击：仅在已启动后触发放烟花，未启动时无任何反应
            canvas.addEventListener('click', (e) => { 
                if (isStarted) {
                    clickToFirework(e.clientX, e.clientY);
                }
                // 未启动时不执行任何操作
            });
            
            // 移动端触摸：仅在已启动后触发放烟花，未启动时无任何反应
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (isStarted) {
                    const touch = e.touches[0];
                    clickToFirework(touch.clientX, touch.clientY);
                }
                // 未启动时不执行任何操作
            }, { passive: false });
        });
    </script>
</body>
</html>