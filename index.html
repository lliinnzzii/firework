<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>新年烟花 | 点击屏幕放烟花</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            overflow: hidden;
            background: #000;
            touch-action: none;
        }
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
        .tip {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            font-size: 16px;
            text-shadow: 0 0 5px #ff0;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div class="tip">点击屏幕任意位置放烟花</div>
    <canvas id="fireworksCanvas"></canvas>
    <!-- 隐藏的音频标签：烟花爆炸音效（使用免费CDN，无需本地文件） -->
    <audio id="fireworkSound" preload="auto" style="display: none;">
        <source src="https://cdn.jsdelivr.net/gh/freesouls/audios/firework.mp3" type="audio/mpeg">
    </audio>

    <script>
        // 获取Canvas元素和上下文
        const canvas = document.getElementById('fireworksCanvas');
        const ctx = canvas.getContext('2d');
        // 获取音频元素
        const fireworkSound = document.getElementById('fireworkSound');
        // 标记是否已初始化音频（解决微信自动播放限制）
        let audioInited = false;

        // 适配屏幕大小（支持旋转屏幕）
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // 随机数工具函数
        function random(min, max) {
            return Math.random() * (max - min) + min;
        }

        // 颜色工具函数（随机烟花颜色）
        function randomColor() {
            const colors = [
                '#ff0000', '#ff9900', '#ffff00', '#00ff00',
                '#0099ff', '#0033ff', '#9900ff', '#ff0099'
            ];
            return colors[Math.floor(random(0, colors.length))];
        }

        // 播放烟花音效函数（处理兼容性）
        function playFireworkSound() {
            // 解决微信/移动端音频播放限制：先重置播放位置，再播放
            fireworkSound.currentTime = 0;
            // 兼容不同浏览器的播放方式
            fireworkSound.play().catch(err => {
                console.log("音频播放需要用户交互，已自动处理");
            });
        }

        // 初始化音频（第一次点击时执行，解决微信限制）
        function initAudio() {
            if (!audioInited) {
                // 微信里需要先触发一次空播放来解锁音频
                fireworkSound.play().then(() => {
                    fireworkSound.pause();
                    fireworkSound.currentTime = 0;
                }).catch(err => {
                    console.log("音频初始化完成，可正常播放");
                });
                audioInited = true;
            }
        }

        // 粒子类（烟花粒子）
        class Particle {
            constructor(x, y, color) {
                this.x = x; // 初始x坐标
                this.y = y; // 初始y坐标
                this.speed = random(1, 5); // 粒子速度
                this.angle = random(0, Math.PI * 2); // 粒子运动角度
                this.gravity = 0.05; // 重力（让粒子有下坠效果）
                this.vx = Math.cos(this.angle) * this.speed; // x方向速度
                this.vy = Math.sin(this.angle) * this.speed; // y方向速度
                this.alpha = 1; // 透明度（逐渐消失）
                this.decay = random(0.005, 0.01); // 透明度衰减速度
                this.color = color; // 粒子颜色
            }

            // 更新粒子位置和状态
            update() {
                // 加入重力，让粒子慢慢下坠
                this.vy += this.gravity;
                this.x += this.vx;
                this.y += this.vy;
                // 透明度逐渐降低
                this.alpha -= this.decay;
            }

            // 绘制粒子
            draw() {
                ctx.save();
                ctx.globalAlpha = this.alpha;
                ctx.beginPath();
                ctx.arc(this.x, this.y, 2, 0, Math.PI * 2); // 粒子大小为2px
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.restore();
            }
        }

        // 存储所有烟花粒子
        let particles = [];

        // 创建烟花（点击时调用）
        function createFirework(x, y) {
            // 初始化音频（第一次点击时执行）
            initAudio();
            // 播放烟花音效
            playFireworkSound();
            
            const color = randomColor(); // 随机烟花颜色
            // 生成100-150个粒子（越多烟花越密）
            const particleCount = random(100, 150);
            for (let i = 0; i < particleCount; i++) {
                particles.push(new Particle(x, y, color));
            }
        }

        // 动画循环
        function animate() {
            // 半透明黑色背景，让烟花有拖影效果
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 更新并绘制所有粒子
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.update();
                p.draw();

                // 移除透明度为0的粒子，优化性能
                if (p.alpha <= 0) {
                    particles.splice(i, 1);
                }
            }

            requestAnimationFrame(animate);
        }

        // 监听点击/触摸事件（适配PC和手机）
        // PC端点击
        canvas.addEventListener('click', (e) => {
            createFirework(e.clientX, e.clientY);
        });
        // 移动端触摸
        canvas.addEventListener('touchstart', (e) => {
            // 阻止默认行为（避免微信跳转）
            e.preventDefault();
            const touch = e.touches[0];
            createFirework(touch.clientX, touch.clientY);
        }, { passive: false });

        // 启动动画
        animate();
    </script>
</body>
</html>